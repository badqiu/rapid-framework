<?xml version="1.0" encoding="UTF-8"?>
<table sqlname="mcenter_account_log"  remarks="帐务信息表">

	<operation name="findAccountLogWithAirExt" paging="true" paramtype="primitive" remarks="帐务明细查询">
    	<sql>
    	<![CDATA[
    	SELECT 
    	IW_ACCOUNT_LOG_ID,TRANS_LOG_ID,MAL.TRANS_DATE,MAL.OUT_DATE,MAL.TRANS_DT,MAL.TRANS_CODE,MAL.TRANS_AMOUNT,MAL.BALANCE,MAL.TRANS_CURRENCY,MAL.ACCOUNT_TYPE,MAL.TRANS_ACCOUNT,OTHER_ACCOUNT_TYPE,OTHER_ACCOUNT,TRANS_INSTITUTION,TRANS_OUT_ORDER_NO,BANK_NAME,TRANS_MEMO,SUB_TRANS_CODE,OUT_BIZ_NO,MODEL,SUITE_ID,IS_WRITE_OFF,IS_RED,OTHER_ACCOUNT_LOG,DELETE_FLAG,VOUCHER_ID,ORGI_VOUCHER_ID,TRANS_OPERATOR,INST_CHANNEL_API,REAL_TRADE_NO,PAY_TYPE,MAE.TRADE_NO,
    	MAE.PNR,MAE.TICKET_NO_START,MAE.TICKET_NO_END,MAE.system_partner,MAE.gmt_trade_create  
    	from mcenter_account_log MAL
			inner join trade_base BTB on MAL.real_trade_no = BTB.trade_no 
			inner join mcenter_air_ext MAE on MAL.real_trade_no = MAE.trade_no
			inner join mcenter_creditpay MC on MAL.real_trade_no = MC.trade_no
    	WHERE 
    		MAL.owner IN <iterate property="owner" open="(" close=")" conjunction=",">#owner[]#</iterate> 
    		
	    	<isNotEmpty prepend="and" property="iwAccountLogId">
				MAL.IW_ACCOUNT_LOG_ID = ?
			</isNotEmpty> 
			
	    	<isNotEmpty prepend="and" property="tradeNo">
				MAL.real_trade_no = #tradeNo#
			</isNotEmpty>
			
	    	<isNotEmpty prepend="and" property="accountNo">
				MAL.trans_account = #accountNo#
			</isNotEmpty>
			
	    	<isNotEmpty prepend="and" property="otherAccountNo">
				MAL.other_account = #otherAccountNo#
			</isNotEmpty>
			
			<isNotEmpty prepend="and" property="transCodes">
					 MAL.trans_code IN
					<iterate property="transCodes" open="(" close=")" conjunction=",">
						#transCodes[]#
					</iterate>
			</isNotEmpty>
	
			<isNotEmpty prepend="and" property="excludeTransCodes">
					 MAL.trans_code NOT IN
					<iterate property="excludeTransCodes" open="(" close=")" conjunction=",">
						#excludeTransCodes[]#
					</iterate>
			</isNotEmpty>
					
			<isNotEmpty prepend="and" property="subTransCodes">
					 MAL.sub_trans_code IN
					<iterate property="subTransCodes" open="(" close=")" conjunction=",">
						#subTransCodes[]#
					</iterate>
			</isNotEmpty>	

			<isNotEmpty prepend="and" property="transDtBegin">
					MAL.trans_dt &gt;= #transDtBegin#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="transDtEnd">
					MAL.trans_dt &lt; #transDtEnd#
			</isNotEmpty>	

			<isNotEmpty prepend="and" property="minTransAmount">
					MAL.TRANS_AMOUNT >= #minTransAmount#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="maxTransAmount">
					MAL.TRANS_AMOUNT &lt;= #maxTransAmount#
			</isNotEmpty>

			<isNotEmpty prepend="and" property="bankName">
					MAL.bank_name = #bankName#
			</isNotEmpty>
			
			<isNotEmpty prepend="and" property="transMemo">
					MAL.trans_memo like #transMemo#
			</isNotEmpty>
												
			<isNotEmpty prepend="and" property="pnr">
					MAE.pnr = #pnr#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="ticketNo">
					MAE.TICKET_NO_END >= #ticketNo#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="ticketNo">
					MAE.TICKET_NO_START &lt;= #ticketNo#
			</isNotEmpty>
			
			<isNotEmpty prepend="and" property="outTradeNo">
					BTB.out_trade_no = #outTradeNo#
			</isNotEmpty>	
			
			<isEqual prepend="and" property="payType" compareValue="BALANCE_PAY">
					MC.pay_success is null
			</isEqual>
			<isEqual prepend="and" property="payType" compareValue="CREDIT_PAY">
					MC.pay_success = 'Y'
			</isEqual>		
					
			/* 用于识别     CREDIT_LOAN("CL","信用支付借款"),CREDIT_RETURN_LOAN("CRL","信用支付还款"),CREDIT_REFUND("CF","信用支付退款"),*/
			<isEqual prepend="and" property="payType" compareValue="CREDIT_LOAN">
				SUB_TRANS_CODE = '301118'  /* 信用支付放贷 */
			</isEqual>
			<isEqual prepend="and" property="payType" compareValue="CREDIT_RETURN_LOAN">
				SUB_TRANS_CODE = '301119' /* 信用支付还贷 */
			</isEqual>
			<isEqual prepend="and" property="payType" compareValue="CREDIT_REFUND">
				SUB_TRANS_CODE = '301101' AND MC.pay_success = 'Y' /* 退款给买家 */
			</isEqual>		
		]]>
		</sql>
    </operation>    
    
    <!-- 需要与帐务查询同步 -->
    <!-- 缺少isIncomeOrOutcome参数传递, owner一定是S开头 -->
	<operation name="countAndSumAccountInfo" multiplicity="one" paramtype="primitive" remarks="账务数据汇总查询">
		<sql>
    	<![CDATA[
    	SELECT count(*) count,sum(TRANS_AMOUNT) sumTransAmount
    	from mcenter_account_log MAL
			inner join trade_base BTB on MAL.real_trade_no = BTB.trade_no 
			inner join mcenter_air_ext MAE on MAL.real_trade_no = MAE.trade_no
			inner join mcenter_creditpay MC on MAL.real_trade_no = MC.trade_no
    	WHERE
    		MAL.owner IN <iterate property="owner" open="(" close=")" conjunction=",">#owner[]#</iterate> 
    		
	    	<isEqual prepend="and" property="isIncomeOrOutcome" compareValue="INCOME">
				MAL.TRANS_AMOUNT > 0
			</isEqual> 
	    	<isEqual prepend="and" property="isIncomeOrOutcome" compareValue="OUTCOME">
				MAL.TRANS_AMOUNT &lt; 0
			</isEqual>
						    	
	    	<isNotEmpty prepend="and" property="iwAccountLogId">
				MAL.IW_ACCOUNT_LOG_ID = ?
			</isNotEmpty> 
			
	    	<isNotEmpty prepend="and" property="tradeNo">
				MAL.real_trade_no = #tradeNo#
			</isNotEmpty>
			
	    	<isNotEmpty prepend="and" property="accountNo">
				MAL.trans_account = #accountNo#
			</isNotEmpty>
			
	    	<isNotEmpty prepend="and" property="otherAccountNo">
				MAL.other_account = #otherAccountNo#
			</isNotEmpty>
			
			<isNotEmpty prepend="and" property="transCodes">
					 MAL.trans_code IN
					<iterate property="transCodes" open="(" close=")" conjunction=",">
						#transCodes[]#
					</iterate>
			</isNotEmpty>
	
			<isNotEmpty prepend="and" property="excludeTransCodes">
					 MAL.trans_code NOT IN
					<iterate property="excludeTransCodes" open="(" close=")" conjunction=",">
						#excludeTransCodes[]#
					</iterate>
			</isNotEmpty>
					
			<isNotEmpty prepend="and" property="subTransCodes">
					 MAL.sub_trans_code IN
					<iterate property="subTransCodes" open="(" close=")" conjunction=",">
						#subTransCodes[]#
					</iterate>
			</isNotEmpty>	

			<isNotEmpty prepend="and" property="transDtBegin">
					MAL.trans_dt &gt;= #transDtBegin#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="transDtEnd">
					MAL.trans_dt &lt; #transDtEnd#
			</isNotEmpty>	

			<isNotEmpty prepend="and" property="minTransAmount">
					MAL.TRANS_AMOUNT >= #minTransAmount#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="maxTransAmount">
					MAL.TRANS_AMOUNT &lt;= #maxTransAmount#
			</isNotEmpty>

			<isNotEmpty prepend="and" property="bankName">
					MAL.bank_name = #bankName#
			</isNotEmpty>
									
			<isNotEmpty prepend="and" property="pnr">
					MAE.pnr = #pnr#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="ticketNo">
					MAE.TICKET_NO_END >= #ticketNo#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="ticketNo">
					MAE.TICKET_NO_START &lt;= #ticketNo#
			</isNotEmpty>														   
		]]>
		</sql>
    </operation>
    
         			
</table>
